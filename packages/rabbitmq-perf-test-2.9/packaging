#!/usr/bin/env bash

set -exo pipefail

main() {
  native_bins | ensure_executable | ensure_valid | install
}

native_bins() {
  ls ./rabbitmq-perf-test-*
}

ensure_executable() {
  while read -r perf_test
  do
    chmod +x "$perf_test"
    echo "$perf_test"
  done
}

ensure_valid() {
  while read -r perf_test
  do
    $perf_test --version | grep --silent "RabbitMQ Perf Test "
    echo "$perf_test"
  done
}

install() {
  while read -r perf_test
  do
    cp --dereference --recursive "$perf_test" "${BOSH_INSTALL_TARGET:?must be defined}"
  done
}

main
