#!/usr/bin/env bash

set -e

true "${RABBITMQ_SERVER_PACKAGE:?must be set}"

(
  cd "${RABBITMQ_SERVER_PACKAGE%/*}"

  wget --continue --no-verbose \
    --output-document "${RABBITMQ_SERVER_PACKAGE_ARCHIVE:?must be set}" \
    "${RABBITMQ_SERVER_PACKAGE_URL:?must be set}"

  case "$RABBITMQ_SERVER_PACKAGE_ARCHIVE" in
    *.tar.gz)
      tar xzf "$RABBITMQ_SERVER_PACKAGE_ARCHIVE"
    ;;
    *.tar.xz)
      tar xJf "$RABBITMQ_SERVER_PACKAGE_ARCHIVE"
    ;;
    *)
      echo "$RABBITMQ_SERVER_PACKAGE_ARCHIVE is not supported"
      exit 1
    ;;
  esac

  cp -fr "rabbitmq_server-${RABBITMQ_SERVER_PACKAGE_VERSION:?must be set}" \
    "${RABBITMQ_SERVER_JOB_PACKAGE:?must be set}"
)
